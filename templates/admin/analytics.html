<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nirya Admin Dashboard</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Nirya Admin Dashboard</h1>
        
        <!-- Real-time Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">Total Sessions</h3>
                <p id="total-sessions" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">Active Sessions</h3>
                <p id="active-sessions" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">Avg. Feedback Score</h3>
                <p id="avg-feedback" class="text-3xl font-bold text-purple-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">Avg. Response Time</h3>
                <p id="avg-response-time" class="text-3xl font-bold text-orange-600">0s</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Hourly Usage</h3>
                <canvas id="hourly-chart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Daily Usage</h3>
                <canvas id="daily-chart"></canvas>
            </div>
        </div>

        <!-- Emotion and Topics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Common Emotions</h3>
                <canvas id="emotions-chart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Popular Topics</h3>
                <canvas id="topics-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO with error handling and reconnection
        const socket = io('/admin', {
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });

        // Chart instances
        let hourlyChart, dailyChart, emotionsChart, topicsChart;

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update stats
            document.getElementById('total-sessions').textContent = data.total_sessions;
            document.getElementById('active-sessions').textContent = data.active_sessions;
            document.getElementById('avg-feedback').textContent = data.average_feedback.toFixed(1);
            document.getElementById('avg-response-time').textContent = data.avg_response_time.toFixed(2) + 's';

            // Update charts
            updateHourlyChart(data.hourly_usage);
            updateDailyChart(data.daily_usage);
            updateEmotionsChart(data.common_emotions);
            updateTopicsChart(data.common_topics);
        }

        // Initialize charts
        function initializeCharts() {
            // Hourly Usage Chart
            hourlyChart = new Chart(document.getElementById('hourly-chart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sessions',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                }
            });

            // Daily Usage Chart
            dailyChart = new Chart(document.getElementById('daily-chart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sessions',
                        data: [],
                        backgroundColor: 'rgb(147, 51, 234)'
                    }]
                }
            });

            // Emotions Chart
            emotionsChart = new Chart(document.getElementById('emotions-chart'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                }
            });

            // Topics Chart
            topicsChart = new Chart(document.getElementById('topics-chart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Mentions',
                        data: [],
                        backgroundColor: 'rgb(34, 197, 94)'
                    }]
                },
                options: {
                    indexAxis: 'y'
                }
            });
        }

        function updateHourlyChart(data) {
            const labels = Object.keys(data).sort();
            const values = labels.map(label => data[label]);
            
            hourlyChart.data.labels = labels;
            hourlyChart.data.datasets[0].data = values;
            hourlyChart.update();
        }

        function updateDailyChart(data) {
            const labels = Object.keys(data).sort();
            const values = labels.map(label => data[label]);
            
            dailyChart.data.labels = labels;
            dailyChart.data.datasets[0].data = values;
            dailyChart.update();
        }

        function updateEmotionsChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            emotionsChart.data.labels = labels;
            emotionsChart.data.datasets[0].data = values;
            emotionsChart.update();
        }

        function updateTopicsChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            topicsChart.data.labels = labels;
            topicsChart.data.datasets[0].data = values;
            topicsChart.update();
        }

        // Socket.IO event handlers
        socket.on('connect', () => {
            console.log('Connected to admin namespace');
            initializeCharts();
            // Use initial data if available
            const initialData = {{ initial_data|tojson|safe }};
            if (initialData) {
                updateDashboard(initialData);
            }
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
            // Attempt to reconnect after connection error
            setTimeout(() => {
                socket.connect();
            }, 1000);
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            if (reason === 'io server disconnect') {
                // Reconnect if server disconnected
                socket.connect();
            }
        });

        socket.on('analytics_update', (data) => {
            console.log('Received analytics update:', data);
            if (data) {
                updateDashboard(data);
            }
        });
    </script>
</body>
</html>
